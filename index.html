<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>DLV Order Hub</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        window.initializeApp = initializeApp;
        import { getFirestore, collection, getDocs, doc, setDoc, addDoc, onSnapshot, query, where, updateDoc, writeBatch, serverTimestamp, deleteDoc, runTransaction, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        window.getFirestore = getFirestore;
        window.collection = collection;
        window.getDocs = getDocs;
        window.doc = doc;
        window.setDoc = setDoc;
        window.addDoc = addDoc;
        window.onSnapshot = onSnapshot;
        window.query = query;
        window.where = where;
        window.updateDoc = updateDoc;
        window.writeBatch = writeBatch;
        window.serverTimestamp = serverTimestamp;
        window.deleteDoc = deleteDoc;
        window.runTransaction = runTransaction;
        window.enableIndexedDbPersistence = enableIndexedDbPersistence;
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        window.getAuth = getAuth;
        window.signInAnonymously = signInAnonymously;
    </script>
    <!-- Recharts -->
    <script src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>
    <!-- Custom Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1050;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 90%;
            width: 500px;
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .toast-container {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            z-index: 2000;
        }
        .toast {
            min-width: 250px;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            animation: fadeInOut 3s ease-in-out forwards;
        }
        .toast-success { background-color: #28a745; }
        .toast-error { background-color: #dc3545; }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
        @media print {
            body * {
                visibility: hidden;
            }
            #printable-report, #printable-report * {
                visibility: visible;
            }
            #printable-report {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>
    <div id="printable-report" class="hidden"></div>

    <script type="text/babel">
        const { useState, useEffect, createContext, useContext, useRef, useMemo } = React;
        
        // --- Firebase Configuration ---
        const primaryFirebaseConfig = {
            apiKey: "AIzaSyArtDGiH3YtVc7Ro43limWa1cCULnVXp4w",
            authDomain: "dlvorders.firebaseapp.com",
            projectId: "dlvorders",
            storageBucket: "dlvorders.appspot.com",
            messagingSenderId: "69353305480",
            appId: "1:69353305480:web:582133ff862edbfbb8763d"
        };
        const secondaryFirebaseConfig = {
            apiKey: "AIzaSyC9Tf7tOlZhYNe6ubDZ7JFJhsMswiimxPw",
            authDomain: "dlv-warehouse-tracker.firebaseapp.com",
            projectId: "dlv-warehouse-tracker",
            storageBucket: "dlv-warehouse-tracker.appspot.com",
            messagingSenderId: "267729758583",
            appId: "1:267729758583:web:f5f7ca26afc99c17819972"
        };
        
        // --- Context for App State ---
        const AppContext = createContext();

        const AppProvider = ({ children }) => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [modal, setModal] = useState({ isOpen: false, message: '', onConfirm: null, onCancel: null, confirmText: 'OK', cancelText: 'Cancel' });
            const [toast, setToast] = useState({ show: false, message: '', type: 'success' });
            const [firebaseInstances, setFirebaseInstances] = useState(null);
            const [newOrderCount, setNewOrderCount] = useState(0);
            const [newToolRequestCount, setNewToolRequestCount] = useState(0);
            const [users, setUsers] = useState([]);
            const [isUsersLoading, setIsUsersLoading] = useState(true);

            useEffect(() => {
                const initializeFirebase = async () => {
                    try {
                        const primaryApp = window.initializeApp(primaryFirebaseConfig, "primary");
                        const primaryDb = window.getFirestore(primaryApp);
                        
                        try {
                           await window.enableIndexedDbPersistence(primaryDb);
                        } catch (err) {
                             if (err.code == 'failed-precondition') {
                                console.warn("Firestore offline persistence failed: multiple tabs open.");
                             } else if (err.code == 'unimplemented') {
                                console.error("Firestore offline persistence not available in this browser.");
                             }
                        }


                        const primaryAuth = window.getAuth(primaryApp);
                        await window.signInAnonymously(primaryAuth);

                        const secondaryApp = window.initializeApp(secondaryFirebaseConfig, "secondary");
                        const secondaryDb = window.getFirestore(secondaryApp);

                        setFirebaseInstances({ primaryDb, secondaryDb });
                    } catch (error) {
                        console.error("Firebase Initialization Error:", error);
                        setModal({ isOpen: true, message: `Failed to connect to databases. Error: ${error.message}` });
                    }
                };
                initializeFirebase();
            }, []);

            useEffect(() => {
                if (!firebaseInstances) return;
                setIsUsersLoading(true);
                const usersCol = window.collection(firebaseInstances.primaryDb, '/public/data/users');
                const unsubscribeUsers = window.onSnapshot(usersCol, (snapshot) => {
                    const usersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setUsers(usersData);
                    setIsUsersLoading(false);
                    if (snapshot.empty) {
                        const defaultUsers = [
                            { username: 'ADMIN', pin: '1234', role: 'admin', fullName: 'ADMINISTRATOR', phoneNumber: 'N/A' },
                            { username: 'WAREHOUSE', pin: '5678', role: 'warehouse', fullName: 'WAREHOUSE STAFF', phoneNumber: 'N/A' },
                            { username: 'JOHN', pin: '1111', role: 'orderer', fullName: 'JOHN DOE', phoneNumber: '123-456-7890' },
                        ];
                        const batch = window.writeBatch(firebaseInstances.primaryDb);
                        defaultUsers.forEach(user => {
                            const docRef = window.doc(usersCol);
                            batch.set(docRef, user);
                        });
                        batch.commit().catch(err => console.error("Error seeding users:", err));
                    }
                }, (error) => {
                    console.error("Error fetching users:", error);
                    showModal("Could not load user accounts from the database.");
                    setIsUsersLoading(false);
                });

                return () => {
                    unsubscribeUsers();
                };
            }, [firebaseInstances]);

            useEffect(() => {
                if(!isUsersLoading && firebaseInstances){
                    setLoading(false);
                }
            }, [isUsersLoading, firebaseInstances]);

            const login = (username, pin) => {
                const foundUser = users.find(u => u.username.toLowerCase() === username.toLowerCase() && u.pin === pin);
                if (foundUser) {
                    setUser(foundUser);
                    localStorage.setItem('dlv_user', JSON.stringify(foundUser));
                    return true;
                }
                setModal({ isOpen: true, message: 'Invalid username or PIN.' });
                return false;
            };

            const logout = () => {
                setUser(null);
                localStorage.removeItem('dlv_user');
                localStorage.removeItem('dlv_cart');
            };
            
            useEffect(() => {
                if (isUsersLoading) return;

                try {
                    const savedUserJSON = localStorage.getItem('dlv_user');
                    if (savedUserJSON) {
                        const savedUser = JSON.parse(savedUserJSON);
                        const currentUserInDb = users.find(u => u.id === savedUser.id);
                        
                        if (currentUserInDb && currentUserInDb.pin === savedUser.pin) {
                            if (!user || user.id !== currentUserInDb.id) {
                                setUser(currentUserInDb);
                            }
                        } else {
                           if(user) logout();
                        }
                    }
                } catch (error) { 
                    console.error("Error reading user session:", error); 
                    logout();
                }
            }, [users, isUsersLoading]);

            const showModal = (optionsOrMessage, onConfirmCallback = null) => {
                if (typeof optionsOrMessage === 'string') {
                    setModal({
                        isOpen: true,
                        message: optionsOrMessage,
                        onConfirm: onConfirmCallback,
                        onCancel: onConfirmCallback ? () => {} : null,
                        confirmText: 'OK',
                        cancelText: 'Cancel'
                    });
                } else {
                    setModal({
                        isOpen: true,
                        message: optionsOrMessage.message || '',
                        onConfirm: optionsOrMessage.onConfirm || null,
                        onCancel: optionsOrMessage.onCancel || null,
                        confirmText: optionsOrMessage.confirmText || 'OK',
                        cancelText: optionsOrMessage.cancelText || 'Cancel'
                    });
                }
            };

            const closeModal = () => setModal({ isOpen: false, message: '', onConfirm: null, onCancel: null, confirmText: 'OK', cancelText: 'Cancel' });

            const showToast = (message, type = 'success') => {
                setToast({ show: true, message, type });
                setTimeout(() => {
                    setToast({ show: false, message: '', type });
                }, 3000);
            };

            const value = { user, users, login, logout, loading, firebaseInstances, modal, showModal, closeModal, toast, showToast, newOrderCount, setNewOrderCount, newToolRequestCount, setNewToolRequestCount };
            return <AppContext.Provider value={value}>{children}</AppContext.Provider>;
        };

        const useAppContext = () => useContext(AppContext);

        const Toast = () => {
            const { toast } = useAppContext();
            if (!toast.show) return null;
            const toastClass = toast.type === 'success' ? 'toast-success' : 'toast-error';
            return (
                <div className="toast-container">
                    <div className={`toast ${toastClass}`}>{toast.message}</div>
                </div>
            );
        };

        const Modal = () => {
            const { modal, closeModal } = useAppContext();
            if (!modal.isOpen) return null;

            const handleConfirm = () => {
                if (modal.onConfirm) modal.onConfirm();
                closeModal();
            };

            const handleCancel = () => {
                if (modal.onCancel) modal.onCancel();
                closeModal();
            };

            if (!modal.onConfirm && !modal.onCancel) {
                 return (
                    <div className="modal-overlay">
                        <div className="modal-content text-center">
                            <p className="mb-6 text-lg">{modal.message}</p>
                            <div className="flex justify-center">
                                <button onClick={closeModal} className="px-6 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700">
                                    {modal.confirmText || 'OK'}
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="modal-overlay">
                    <div className="modal-content text-center">
                        <p className="mb-6 text-lg">{modal.message}</p>
                        <div className="flex justify-center space-x-4">
                            {modal.onCancel && (
                                 <button onClick={handleCancel} className="px-6 py-2 rounded-md bg-gray-200 text-gray-800 hover:bg-gray-300">
                                    {modal.cancelText}
                                </button>
                            )}
                            {modal.onConfirm && (
                                <button onClick={handleConfirm} className="px-6 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700">
                                    {modal.confirmText}
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const LoadingSpinner = ({ message = "Loading..." }) => (
            <div className="flex flex-col items-center justify-center h-screen bg-gray-100">
                <div className="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                <p className="mt-4 text-lg text-gray-600">{message}</p>
            </div>
        );

        const ButtonSpinner = () => (
            <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        );

        const Header = () => {
            const { user, logout } = useAppContext();
            return (
                <header className="bg-white p-2 sm:p-4 flex justify-between items-center">
                    <img src="https://i.imgur.com/pmh9SN0.png" alt="DLV Order Hub Logo" className="h-8 sm:h-10" />
                    {user && (
                        <div className="flex flex-col sm:flex-row items-end sm:items-center sm:space-x-4">
                            <span className="text-gray-600 text-right text-sm sm:text-base">Welcome, <span className="font-semibold">{user.username}</span> ({user.role})</span>
                            <div className="flex space-x-2 mt-1 sm:mt-0">
                                <button onClick={logout} className="px-3 py-1 sm:px-4 sm:py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors text-sm sm:text-base">Logout</button>
                            </div>
                        </div>
                    )}
                </header>
            );
        };
        
        const Nav = ({ setCurrentPage }) => {
            const { user, newOrderCount, setNewOrderCount, newToolRequestCount, setNewToolRequestCount } = useAppContext();

            const handleNavClick = (page) => {
                if (page === 'order_management') setNewOrderCount(0);
                if (page === 'tool_requests') setNewToolRequestCount(0);
                setCurrentPage(page);
            };

            if (!user) return null;

            const NavLinks = () => {
                const buttonClass = "flex-shrink-0 px-4 py-2 rounded-md text-sm font-medium text-gray-300 hover:text-white hover:bg-gray-700 transition-colors";
                const flexButtonClass = `${buttonClass} flex items-center space-x-2`;

                return (
                    <>
                        {(user.role === 'orderer' || user.role === 'admin') && (
                            <>
                                <li><button onClick={() => handleNavClick('inventory')} className={buttonClass}>Inventory</button></li>
                                <li><button onClick={() => handleNavClick('cart')} className={buttonClass}>Cart</button></li>
                                <li><button onClick={() => handleNavClick('order_history')} className={buttonClass}>History</button></li>
                                <li><button onClick={() => handleNavClick('tools')} className={buttonClass}>Tools</button></li>
                                <li><button onClick={() => handleNavClick('my_tool_requests')} className={buttonClass}>My Requests</button></li>
                            </>
                        )}
                        {(user.role === 'warehouse' || user.role === 'admin') && (
                            <>
                                <li>
                                    <button onClick={() => handleNavClick('order_management')} className={flexButtonClass}>
                                        <span>Order Mgmt</span>
                                        {newOrderCount > 0 && <span className="bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">{newOrderCount}</span>}
                                    </button>
                                </li>
                                <li>
                                    <button onClick={() => handleNavClick('tool_requests')} className={flexButtonClass}>
                                        <span>Tool Requests</span>
                                        {newToolRequestCount > 0 && <span className="ml-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">{newToolRequestCount}</span>}
                                    </button>
                                </li>
                            </>
                        )}
                        {user.role === 'admin' && (
                            <>
                                <li><button onClick={() => handleNavClick('user_management')} className={buttonClass}>User Mgmt</button></li>
                                <li><button onClick={() => handleNavClick('tools_management')} className={buttonClass}>Tools Mgmt</button></li>
                                <li><button onClick={() => handleNavClick('forecasting')} className={buttonClass}>Forecasting</button></li>
                            </>
                        )}
                    </>
                );
            };

            return (
                <nav className="bg-gray-800">
                    <div className="w-full overflow-x-auto no-scrollbar">
                        <div className="px-4">
                            <ul className="flex items-center space-x-2 h-16">
                                <NavLinks />
                            </ul>
                        </div>
                    </div>
                </nav>
            );
        };

        const WelcomePage = ({ onVideoEnd }) => (
            <div className="fixed inset-0 w-screen h-screen bg-black overflow-hidden" onClick={onVideoEnd}>
                <video src="https://i.imgur.com/ys1F2xc.mp4" muted autoPlay onEnded={onVideoEnd} className="absolute top-0 left-0 w-full h-full object-cover z-0"></video>
            </div>
        );

        const LoginPage = () => {
            const [username, setUsername] = useState('');
            const [pin, setPin] = useState('');
            const { login, showModal } = useAppContext();
            const handleLogin = (e) => {
                e.preventDefault();
                if (pin.length !== 4 || !/^\d{4}$/.test(pin)) {
                    showModal("PIN must be 4 digits.");
                    return;
                }
                login(username, pin);
            };
            return (
                <div className="flex items-center justify-center min-h-screen bg-gray-100 p-4">
                    <div className="p-8 bg-white rounded-lg shadow-xl w-full max-w-md">
                        <div className="flex justify-center mb-6"><img src="https://i.imgur.com/pmh9SN0.png" alt="DLV Order Hub Logo" className="h-12" /></div>
                        <h2 className="text-2xl font-bold mb-6 text-center text-gray-700">Login</h2>
                        <form onSubmit={handleLogin}>
                            <div className="mb-4">
                                <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="username">Username</label>
                                <input id="username" type="text" value={username} onChange={(e) => setUsername(e.target.value.toUpperCase())} className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline uppercase" required />
                            </div>
                            <div className="mb-6">
                                <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="pin">4-Digit PIN</label>
                                <input id="pin" type="password" maxLength="4" value={pin} onChange={(e) => setPin(e.target.value.replace(/\D/,''))} className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" required />
                            </div>
                            <div className="flex items-center justify-center">
                                <button type="submit" className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline w-full transition-colors">Sign In</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };
        
        const InventoryPage = ({ setCurrentPage }) => {
            const { user, firebaseInstances, showModal, showToast } = useAppContext();
            const [inventory, setInventory] = useState([]);
            const [loading, setLoading] = useState(true);
            const [searchTerm, setSearchTerm] = useState("");
            const [overrides, setOverrides] = useState({});
            const [cart, setCart] = useState(() => {
                try {
                    const savedCart = localStorage.getItem('dlv_cart');
                    return savedCart ? JSON.parse(savedCart) : {};
                } catch { return {}; }
            });

            useEffect(() => {
                if (!firebaseInstances) return;
                const fetchData = async () => {
                    setLoading(true);
                    try {
                        const inventoryCol = window.collection(firebaseInstances.secondaryDb, '/artifacts/default-app-id/public/data/inventory');
                        const inventorySnapshot = await window.getDocs(inventoryCol);
                        const inventoryData = inventorySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        inventoryData.sort((a, b) => a.name.localeCompare(b.name));
                        setInventory(inventoryData);

                        const overridesCol = window.collection(firebaseInstances.primaryDb, '/public/data/inventory_overrides');
                        const unsubscribe = onSnapshot(overridesCol, (snapshot) => {
                            const overridesData = {};
                            snapshot.forEach(doc => {
                                overridesData[doc.id] = doc.data();
                            });
                            setOverrides(overridesData);
                        });
                        return unsubscribe;

                    } catch (error) {
                        console.error("Error fetching inventory:", error);
                        showModal("Failed to load inventory data.");
                    } finally {
                        setLoading(false);
                    }
                };
                fetchData();
            }, [firebaseInstances]);

            useEffect(() => { localStorage.setItem('dlv_cart', JSON.stringify(cart)); }, [cart]);

            const handleAddToCart = (item, quantity) => {
                if (quantity <= 0) return;
                setCart(prevCart => {
                    const existingItem = prevCart[item.id];
                    return { ...prevCart, [item.id]: { ...item, quantity: (existingItem ? existingItem.quantity : 0) + quantity }};
                });
                showModal({
                    message: `${quantity} x ${item.name} added to cart!`,
                    confirmText: 'Go to Cart',
                    onConfirm: () => setCurrentPage('cart'),
                    cancelText: 'Continue Shopping',
                    onCancel: () => {}
                });
            };

            const handleAddPicture = async (itemId) => {
                const imageUrl = prompt("Enter the new image URL:");
                if (imageUrl) {
                    try {
                        const docRef = window.doc(firebaseInstances.primaryDb, `/public/data/inventory_overrides/${itemId}`);
                        await window.setDoc(docRef, { imageUrl }, { merge: true });
                        showToast("Custom image updated!", 'success');
                    } catch (error) {
                        console.error("Error updating image URL:", error);
                        showToast("Failed to update image URL.", 'error');
                    }
                }
            };

            const handleToggleVisibility = async (item) => {
                const docRef = window.doc(firebaseInstances.primaryDb, `/public/data/inventory_overrides/${item.id}`);
                const currentVisibility = overrides[item.id]?.visible !== false;
                try {
                    await window.setDoc(docRef, { visible: !currentVisibility }, { merge: true });
                } catch (error) {
                    console.error("Error toggling visibility:", error);
                    showToast("Failed to update visibility.", 'error');
                }
            };
            
            const filteredInventory = inventory
                .filter(item => {
                    if (user.role === 'admin') return true;
                    return overrides[item.id]?.visible !== false;
                })
                .filter(item => 
                    (item.name && item.name.toLowerCase().includes(searchTerm.toLowerCase())) ||
                    (item.description && item.description.toLowerCase().includes(searchTerm.toLowerCase()))
                );

            if (loading) return <LoadingSpinner message="Loading Inventory..." />;

            return (
                <div className="p-4 sm:p-6 lg:p-8">
                    <h2 className="text-3xl font-bold mb-6">Inventory</h2>
                    <div className="sticky top-0 bg-gray-100 py-4 z-10">
                         <input type="text" placeholder="Search inventory..." className="w-full p-3 border rounded-lg shadow-sm uppercase" value={searchTerm} onChange={e => setSearchTerm(e.target.value.toUpperCase())} />
                    </div>
                    <div className="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 sm:gap-6 mt-4">
                        {filteredInventory.map((item) => {
                            const isVisible = overrides[item.id]?.visible !== false;
                            return (
                            <div key={item.id} className={`bg-white rounded-lg shadow-lg overflow-hidden flex flex-col ${!isVisible && user.role === 'admin' ? 'opacity-50' : ''}`}>
                                <img src={overrides[item.id]?.imageUrl || 'https://placehold.co/400x300/e2e8f0/cbd5e0?text=No+Image'} alt={item.name} className="w-full h-32 sm:h-48 object-cover" onError={(e) => { e.target.onerror = null; e.target.src='https://placehold.co/400x300/e2e8f0/cbd5e0?text=Image+Error'; }} />
                                <div className="p-2 sm:p-4 flex flex-col flex-grow">
                                    <h3 className="text-base sm:text-xl font-bold">{item.name}</h3>
                                    <p className="text-gray-600 text-xs sm:text-base mt-2 flex-grow">{item.description}</p>
                                    <div className="mt-auto pt-4">
                                        <form onSubmit={(e) => { e.preventDefault(); const quantity = parseInt(e.target.elements.quantity.value); handleAddToCart(item, quantity); e.target.elements.quantity.value = 1; }} className="flex items-center space-x-2">
                                            <input type="number" name="quantity" defaultValue="1" min="1" className="w-12 sm:w-16 p-2 border rounded" />
                                            <button type="submit" className="flex-1 bg-blue-600 text-white p-2 rounded hover:bg-blue-700 text-sm">Add</button>
                                        </form>
                                        {user.role === 'admin' && (
                                            <div className="mt-2 space-y-2">
                                                <button onClick={() => handleAddPicture(item.id)} className="w-full bg-yellow-500 text-white p-2 rounded hover:bg-yellow-600 text-sm">Picture</button>
                                                <div className="flex items-center justify-center">
                                                    <span className="text-sm mr-2">{isVisible ? 'Visible' : 'Hidden'}</span>
                                                    <button onClick={() => handleToggleVisibility(item)} className={`relative inline-flex flex-shrink-0 h-6 w-11 border-2 border-transparent rounded-full cursor-pointer transition-colors ease-in-out duration-200 focus:outline-none ${isVisible ? 'bg-blue-600' : 'bg-gray-200'}`}>
                                                        <span aria-hidden="true" className={`inline-block h-5 w-5 rounded-full bg-white shadow transform ring-0 transition ease-in-out duration-200 ${isVisible ? 'translate-x-5' : 'translate-x-0'}`} />
                                                    </button>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        )})}
                    </div>
                </div>
            );
        };

        const CartPage = ({ setCurrentPage }) => {
            const { user, firebaseInstances, showModal, showToast } = useAppContext();
            const [cart, setCart] = useState(() => { try { const sc = localStorage.getItem('dlv_cart'); return sc ? JSON.parse(sc) : {}; } catch { return {}; } });
            const [sites, setSites] = useState([]);
            const [selectedSite, setSelectedSite] = useState('');
            const [specialRequests, setSpecialRequests] = useState('');
            const [isPlacingOrder, setIsPlacingOrder] = useState(false);
            
            useEffect(() => {
                if (!firebaseInstances) return;
                const fetchSites = async () => {
                    try {
                        const sitesCol = window.collection(firebaseInstances.secondaryDb, '/artifacts/default-app-id/public/data/sites');
                        const sitesSnapshot = await window.getDocs(sitesCol);
                        setSites(sitesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    } catch (error) { console.error("Error fetching sites:", error); }
                };
                fetchSites();
            }, [firebaseInstances]);

            const updateQuantity = (itemId, newQuantity) => {
                if (newQuantity <= 0) { removeItem(itemId); return; }
                const newCart = { ...cart };
                newCart[itemId].quantity = newQuantity;
                setCart(newCart);
                localStorage.setItem('dlv_cart', JSON.stringify(newCart));
            };

            const removeItem = (itemId) => {
                const newCart = { ...cart };
                delete newCart[itemId];
                setCart(newCart);
                localStorage.setItem('dlv_cart', JSON.stringify(newCart));
            };

            const handlePlaceOrder = async () => {
                if (Object.keys(cart).length === 0) { showModal("Your cart is empty."); return; }
                if (!selectedSite) { showModal("Please select a project site."); return; }
                
                setIsPlacingOrder(true);
                try {
                    const orderData = { userId: user.id, username: user.username, siteId: selectedSite, siteName: sites.find(s => s.id === selectedSite)?.name || 'Unknown', specialRequests, status: 'Pending', createdAt: window.serverTimestamp(), items: Object.values(cart).map(item => ({ id: item.id, name: item.name, quantity: item.quantity, status: 'Pending' })), communication: [], isNew: true };
                    const ordersCol = window.collection(firebaseInstances.primaryDb, 'orders');
                    await window.addDoc(ordersCol, orderData);
                    setCart({});
                    localStorage.removeItem('dlv_cart');
                    showToast("Order placed successfully!", 'success');
                    setCurrentPage('order_history');
                } catch (error) {
                    console.error("Error placing order:", error);
                    showToast(`Failed to place order. Error: ${error.message}`, 'error');
                } finally {
                    setIsPlacingOrder(false);
                }
            };
            
            return (
                <div className="p-4 sm:p-6 lg:p-8">
                    <h2 className="text-3xl font-bold mb-6">Shopping Cart</h2>
                    {Object.values(cart).length === 0 ? (
                        <p className="text-center text-gray-500 text-xl">Your cart is empty.</p>
                    ) : (
                        <div className="bg-white p-6 rounded-lg shadow-md">
                            {Object.values(cart).map(item => (
                                <div key={item.id} className="flex flex-col sm:flex-row items-start sm:items-center justify-between py-4 border-b">
                                    <span className="font-semibold w-full sm:w-1/2 mb-2 sm:mb-0">{item.name}</span>
                                    <div className="flex items-center space-x-4">
                                        <input type="number" value={item.quantity} onChange={e => updateQuantity(item.id, parseInt(e.target.value))} className="w-20 p-1 border rounded text-center" />
                                        <button onClick={() => removeItem(item.id)} className="text-red-500 hover:text-red-700">Remove</button>
                                    </div>
                                </div>
                            ))}
                            <div className="mt-6">
                                <h3 className="text-xl font-semibold mb-4">Order Details</h3>
                                <div className="mb-4">
                                    <label className="block text-gray-700 font-bold mb-2">Project Site</label>
                                    <select value={selectedSite} onChange={e => setSelectedSite(e.target.value)} className="w-full p-2 border rounded bg-white">
                                        <option value="" disabled>Select a site</option>
                                        {sites.map(site => <option key={site.id} value={site.id}>{site.name}</option>)}
                                    </select>
                                </div>
                                <div className="mb-4">
                                    <label className="block text-gray-700 font-bold mb-2">Special Requests</label>
                                    <textarea value={specialRequests} onChange={e => setSpecialRequests(e.target.value.toUpperCase())} className="w-full p-2 border rounded uppercase" rows="3"></textarea>
                                </div>
                                <button onClick={handlePlaceOrder} disabled={isPlacingOrder} className="w-full bg-green-600 text-white p-3 rounded-lg font-bold hover:bg-green-700 disabled:bg-gray-400 flex items-center justify-center">
                                    {isPlacingOrder ? <ButtonSpinner /> : 'Place Order'}
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const OrderHistoryPage = () => {
            const { user, firebaseInstances, showModal } = useAppContext();
            const [orders, setOrders] = useState([]);
            const [loading, setLoading] = useState(true);
            const [selectedOrder, setSelectedOrder] = useState(null);
            const [newMessage, setNewMessage] = useState("");

            useEffect(() => {
                if (!firebaseInstances || !user) return;
                setLoading(true);
                const q = window.query(window.collection(firebaseInstances.primaryDb, "orders"), where("userId", "==", user.id));
                const unsubscribe = window.onSnapshot(q, (querySnapshot) => {
                    const ordersData = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                    setOrders(ordersData);
                    setLoading(false);
                }, (error) => {
                    console.error("Error fetching order history:", error);
                    showModal("Failed to load order history.");
                    setLoading(false);
                });
                return () => unsubscribe();
            }, [firebaseInstances, user]);
            
            const handleSendMessage = async () => {
                if (!newMessage.trim() || !selectedOrder) return;
                const updatedCommunication = [...(selectedOrder.communication || []), { sender: user.username, message: newMessage, timestamp: new Date() }];
                try {
                    const orderRef = window.doc(firebaseInstances.primaryDb, 'orders', selectedOrder.id);
                    await window.updateDoc(orderRef, { communication: updatedCommunication });
                    setSelectedOrder(prev => ({...prev, communication: updatedCommunication}));
                    setNewMessage("");
                } catch (error) {
                    console.error("Error sending message:", error);
                    showModal("Failed to send message.");
                }
            };

            if (loading) return <LoadingSpinner message="Loading Order History..." />;
            
            return (
                <div className="p-4 sm:p-6 lg:p-8 grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div className="md:col-span-1">
                        <h2 id="order-history-header" className="text-3xl font-bold mb-6">My Orders</h2>
                        <div className="bg-white p-4 rounded-lg shadow-md space-y-3 max-h-[70vh] overflow-y-auto">
                            {orders.length === 0 && <p>You have no orders.</p>}
                            {orders.map(order => (
                                <div key={order.id} onClick={() => setSelectedOrder(order)} className={`p-4 border rounded-lg cursor-pointer ${selectedOrder?.id === order.id ? 'bg-blue-100 border-blue-500' : 'hover:bg-gray-50'}`}>
                                    <p className="font-semibold">Order #{order.id.substring(0, 6)}...</p>
                                    <p>Site: {order.siteName}</p>
                                    <p>Status: <span className="font-medium">{order.status}</span></p>
                                    <p className="text-sm text-gray-500">{order.createdAt?.toDate().toLocaleString()}</p>
                                </div>
                            ))}
                        </div>
                    </div>
                    <div className="md:col-span-2 bg-white p-6 rounded-lg shadow-md">
                        {selectedOrder ? (
                            <div>
                                <h3 className="text-2xl font-bold mb-4">Order Details</h3>
                                <div className="mb-6 p-4 border rounded-lg bg-gray-50">
                                    <label className="block font-semibold mb-3 text-gray-700">Order Progress</label>
                                    <OrderStatusChecklist currentStatus={selectedOrder.status} />
                                </div>
                                <p><span className="font-semibold">Site:</span> {selectedOrder.siteName}</p>
                                <p><span className="font-semibold">Special Requests:</span> {selectedOrder.specialRequests || 'None'}</p>
                                <h4 className="text-xl font-semibold mt-6 mb-2">Items</h4>
                                <ul className="list-disc list-inside space-y-1">
                                    {selectedOrder.items.map(item => (
                                        <li key={item.id}>{item.name} (x{item.quantity}) - <span className="italic">{item.status}</span></li>
                                    ))}
                                </ul>
                                <h4 className="text-xl font-semibold mt-6 mb-2">Communication</h4>
                                <div className="border rounded-lg p-4 h-48 overflow-y-auto bg-gray-50 mb-4">
                                    {(selectedOrder.communication || []).length === 0 && <p className="text-gray-500">No messages yet.</p>}
                                    {(selectedOrder.communication || []).map((msg, i) => (
                                        <p key={i}><span className="font-semibold">{msg.sender}:</span> {msg.message}</p>
                                    ))}
                                </div>
                                <div className="flex space-x-2">
                                    <input type="text" value={newMessage} onChange={e => setNewMessage(e.target.value.toUpperCase())} placeholder="Type a follow-up message..." className="flex-grow p-2 border rounded uppercase" />
                                    <button onClick={handleSendMessage} className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Send</button>
                                </div>
                            </div>
                        ) : (
                            <p className="text-center text-gray-500 text-xl">Select an order to view details.</p>
                        )}
                    </div>
                </div>
            );
        };
        
        const OrderStatusChecklist = ({ currentStatus, onStatusUpdate }) => {
            const statuses = ["Processing", "Awaiting Pickup", "In Transit", "Delivered"];
            const currentIndex = statuses.indexOf(currentStatus);
            const colors = ['bg-red-500', 'bg-yellow-500', 'bg-blue-500', 'bg-green-500'];

            return (
                <div className="w-full">
                    <div className="flex items-center">
                        {statuses.map((status, index) => {
                            const isCompleted = index < currentIndex;
                            const isCurrent = index === currentIndex;
                            const nodeColor = isCompleted || isCurrent ? colors[index] : 'bg-gray-300';
                            const textColor = isCompleted || isCurrent ? 'text-gray-800' : 'text-gray-500';
                            const lineColor = isCompleted ? colors[index] : 'bg-gray-300';
                            return (
                                <React.Fragment key={status}>
                                    <div className="flex flex-col items-center cursor-pointer" onClick={() => onStatusUpdate && onStatusUpdate(status)}>
                                        <div className={`w-6 h-6 rounded-full ${nodeColor} flex items-center justify-center`}>
                                            {isCompleted && <span className="text-white font-bold text-sm">✓</span>}
                                        </div>
                                        <p className={`mt-2 text-xs sm:text-sm text-center font-semibold ${textColor}`}>{status}</p>
                                    </div>
                                    {index < statuses.length - 1 && <div className={`flex-1 h-1 mx-2 ${lineColor}`}></div>}
                                </React.Fragment>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const OrderManagementPage = () => {
            const { user, firebaseInstances, showModal, setNewOrderCount } = useAppContext();
            const [orders, setOrders] = useState([]);
            const [loading, setLoading] = useState(true);
            const [selectedOrder, setSelectedOrder] = useState(null);
            const [newMessage, setNewMessage] = useState("");
            const [viewArchived, setViewArchived] = useState(false);
            const ITEM_STATUSES = ["Pending", "Picked", "Out of Stock", "Substituted"];

            useEffect(() => { setNewOrderCount(0); }, []);
            
            useEffect(() => {
                if (!firebaseInstances) return;
                setLoading(true);
                const q = window.query(window.collection(firebaseInstances.primaryDb, "orders"));
                const unsubscribe = window.onSnapshot(q, (querySnapshot) => {
                    const ordersData = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                    setOrders(ordersData);
                    setLoading(false);
                }, (error) => {
                    console.error("Error fetching orders:", error);
                    if (error.code === 'permission-denied') { showModal("Could not load orders due to a permissions issue. Please check the security rules in your Firebase project."); } else { showModal("Failed to load orders."); }
                    setLoading(false);
                });
                return () => unsubscribe();
            }, [firebaseInstances]);

            useEffect(() => {
                if (selectedOrder) {
                    const updatedSelectedOrder = orders.find(o => o.id === selectedOrder.id);
                    if (updatedSelectedOrder) setSelectedOrder(updatedSelectedOrder);
                }
            }, [orders]);
            
            const updateOrderStatus = async (orderId, status) => {
                try {
                    const orderRef = window.doc(firebaseInstances.primaryDb, 'orders', orderId);
                    await window.updateDoc(orderRef, { status });
                } catch (error) { console.error("Error updating order status:", error); showModal("Failed to update order status."); }
            };
            
            const updateItemStatus = async (orderId, itemIndex, status) => {
                const orderToUpdate = orders.find(o => o.id === orderId);
                if (!orderToUpdate) return;
                const updatedItems = orderToUpdate.items.map((item, index) => index === itemIndex ? { ...item, status: status } : item);
                try {
                    const orderRef = window.doc(firebaseInstances.primaryDb, 'orders', orderId);
                    await window.updateDoc(orderRef, { items: updatedItems });
                } catch (error) { console.error("Error updating item status:", error); showModal("Failed to update item status."); }
            };

            const handleSendMessage = async () => {
                if (!newMessage.trim() || !selectedOrder) return;
                const updatedCommunication = [...(selectedOrder.communication || []), { sender: user.username, message: newMessage, timestamp: new Date() }];
                try {
                    const orderRef = window.doc(firebaseInstances.primaryDb, 'orders', selectedOrder.id);
                    await window.updateDoc(orderRef, { communication: updatedCommunication });
                    setNewMessage("");
                } catch (error) { console.error("Error sending message:", error); showModal("Failed to send message."); }
            };

            const handleSelectOrder = async (order) => {
                setSelectedOrder(order);
                if (order.isNew) {
                    try {
                        const orderRef = window.doc(firebaseInstances.primaryDb, 'orders', order.id);
                        await window.updateDoc(orderRef, { isNew: false });
                    } catch (error) { console.error("Error marking order as seen:", error); }
                }
            };
            
            const handleArchiveOrder = async (orderId) => {
                 try {
                    const orderRef = window.doc(firebaseInstances.primaryDb, 'orders', orderId);
                    await window.updateDoc(orderRef, { archived: true });
                    setSelectedOrder(null);
                    showModal("Order archived successfully.");
                } catch (error) { console.error("Error archiving order:", error); showModal("Failed to archive order."); }
            }

            const getOrderStatusColorClass = (status) => {
                switch (status) {
                    case 'Pending': return 'bg-red-100 border-red-300 hover:bg-red-200';
                    case 'Processing': case 'Waiting for Supplier': return 'bg-orange-100 border-orange-300 hover:bg-orange-200';
                    case 'Awaiting Pickup': return 'bg-yellow-200 border-yellow-400 hover:bg-yellow-300';
                    case 'In Transit': return 'bg-yellow-100 border-yellow-300 hover:bg-yellow-200';
                    case 'Delivered': return 'bg-green-100 border-green-300 hover:bg-green-200';
                    case 'Cancelled': return 'bg-slate-200 border-slate-400 text-gray-500';
                    default: return 'bg-white hover:bg-gray-50';
                }
            };

            if (loading) return <LoadingSpinner message="Loading All Orders..." />;

            const filteredOrders = orders.filter(order => viewArchived ? order.archived : !order.archived);

            return (
                 <div className="p-4 sm:p-6 lg:p-8 grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div className="md:col-span-1">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-3xl font-bold">All Orders</h2>
                            <div className="flex items-center space-x-2">
                                <span className="text-sm">{viewArchived ? 'Archived' : 'Active'}</span>
                                <button onClick={() => setViewArchived(!viewArchived)} className="bg-gray-200 p-1 rounded-full w-12">
                                    <span className={`block w-5 h-5 rounded-full transition-transform ${viewArchived ? 'translate-x-5' : ''} bg-blue-600`}></span>
                                </button>
                            </div>
                        </div>
                        <div className="bg-white p-4 rounded-lg shadow-md space-y-3 max-h-[80vh] overflow-y-auto">
                            {filteredOrders.length === 0 && <p>No {viewArchived ? 'archived' : 'active'} orders found.</p>}
                            {filteredOrders.map(order => {
                                const statusColorClass = getOrderStatusColorClass(order.status);
                                const isSelected = selectedOrder?.id === order.id;
                                const isNewClass = order.isNew && !isSelected ? 'border-4 border-yellow-400' : 'border';
                                return (
                                    <div key={order.id} onClick={() => handleSelectOrder(order)} className={`p-4 rounded-lg cursor-pointer relative transition-colors ${isNewClass} ${isSelected ? 'border-4 border-blue-600 bg-blue-100' : statusColorClass}`}>
                                        {order.isNew && !isSelected && <span className="absolute -top-2 -right-2 text-xs font-bold bg-yellow-400 text-yellow-900 px-2 py-1 rounded-full animate-pulse">NEW</span>}
                                        <p className="font-semibold">Order #{order.id.substring(0, 6)}... ({order.username})</p>
                                        <p>Site: {order.siteName}</p>
                                        <p>Status: <span className="font-medium">{order.status}</span></p>
                                        <p className="text-sm text-gray-500">{order.createdAt?.toDate().toLocaleString()}</p>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                    <div className="md:col-span-2 bg-white p-6 rounded-lg shadow-md">
                        {selectedOrder ? (
                            <div>
                                <h3 className="text-2xl font-bold mb-4">Manage Order #{selectedOrder.id.substring(0, 6)}</h3>
                                <div className="mb-6 p-4 border rounded-lg bg-gray-50">
                                    <label className="block font-semibold mb-3 text-gray-700">Order Progress</label>
                                    <OrderStatusChecklist currentStatus={selectedOrder.status} onStatusUpdate={(newStatus) => updateOrderStatus(selectedOrder.id, newStatus)} />
                                </div>
                                <div className="grid grid-cols-2 gap-4 mb-6">
                                    <button onClick={() => updateOrderStatus(selectedOrder.id, "Waiting for Supplier")} className={`p-2 rounded-lg text-white font-semibold transition-colors ${selectedOrder.status === 'Waiting for Supplier' ? 'bg-orange-500' : 'bg-orange-400 hover:bg-orange-500'}`}>Set to: Waiting for Supplier</button>
                                    <button onClick={() => updateOrderStatus(selectedOrder.id, "Cancelled")} className={`p-2 rounded-lg text-white font-semibold transition-colors ${selectedOrder.status === 'Cancelled' ? 'bg-red-600' : 'bg-red-500 hover:bg-red-600'}`}>Set to: Cancelled</button>
                                </div>
                                <p className="mb-1"><span className="font-semibold">Orderer:</span> {selectedOrder.username}</p>
                                <p className="mb-4"><span className="font-semibold">Site:</span> {selectedOrder.siteName}</p>
                                {selectedOrder.specialRequests && <p className="mb-4 p-3 bg-yellow-100 border border-yellow-200 rounded-lg"><span className="font-semibold">Special Requests:</span> {selectedOrder.specialRequests}</p>}
                                <h4 className="text-xl font-semibold mt-6 mb-2">Items</h4>
                                <div className="space-y-2">
                                    {selectedOrder.items.map((item, index) => (
                                        <div key={item.id} className="flex items-center justify-between p-2 bg-gray-50 rounded">
                                            <span>{item.name} (x{item.quantity})</span>
                                            <select value={item.status} onChange={e => updateItemStatus(selectedOrder.id, index, e.target.value)} className="p-1 border rounded bg-white">
                                                {ITEM_STATUSES.map(s => <option key={s} value={s}>{s}</option>)}
                                            </select>
                                        </div>
                                    ))}
                                </div>
                                <h4 className="text-xl font-semibold mt-6 mb-2">Communication</h4>
                                <div className="border rounded-lg p-4 h-48 overflow-y-auto bg-gray-50 mb-4">
                                    {(selectedOrder.communication || []).length === 0 && <p className="text-gray-500">No messages yet.</p>}
                                    {(selectedOrder.communication || []).map((msg, i) => (
                                        <p key={i}><span className="font-semibold">{msg.sender}:</span> {msg.message}</p>
                                    ))}
                                </div>
                                <div className="flex space-x-2">
                                    <input type="text" value={newMessage} onChange={e => setNewMessage(e.target.value.toUpperCase())} placeholder="Type a reply..." className="flex-grow p-2 border rounded uppercase" />
                                    <button onClick={handleSendMessage} className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Reply</button>
                                </div>
                                {(selectedOrder.status === 'Delivered' || selectedOrder.status === 'Cancelled') && (
                                    <button onClick={() => handleArchiveOrder(selectedOrder.id)} className="w-full mt-4 bg-gray-600 text-white p-3 rounded-lg font-bold hover:bg-gray-700">Archive Order</button>
                                )}
                            </div>
                        ) : (
                            <div className="flex items-center justify-center h-full">
                                <p className="text-center text-gray-500 text-xl">Select an order to manage.</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };
        
        const UserManagementPage = () => {
            const { users, firebaseInstances, showModal } = useAppContext();
            const [editingUser, setEditingUser] = useState(null);
            const [newUser, setNewUser] = useState({ username: '', pin: '', role: 'orderer', fullName: '', phoneNumber: '' });

            const handleAddUser = async (e) => {
                e.preventDefault();
                if (!firebaseInstances) return;
                if (!newUser.username || !newUser.pin || newUser.pin.length !== 4) {
                    showModal("Please provide a username and a 4-digit PIN.");
                    return;
                }
                if (users.some(u => u.username.toLowerCase() === newUser.username.toLowerCase())) {
                    showModal("A user with this username already exists.");
                    return;
                }

                try {
                    const usersCol = window.collection(firebaseInstances.primaryDb, '/public/data/users');
                    await window.addDoc(usersCol, { 
                        username: newUser.username.toUpperCase(),
                        pin: newUser.pin,
                        role: newUser.role,
                        fullName: newUser.fullName.toUpperCase(),
                        phoneNumber: newUser.phoneNumber
                    });
                    setNewUser({ username: '', pin: '', role: 'orderer', fullName: '', phoneNumber: '' });
                    showModal("User added successfully!");
                } catch (error) {
                    console.error("Error adding user:", error);
                    showModal("Failed to add user.");
                }
            };

            const handleUpdateUser = async () => {
                if (!firebaseInstances) return;
                if (!editingUser.pin || editingUser.pin.length !== 4) {
                    showModal("PIN must be 4 digits.");
                    return;
                }
                try {
                    const userDoc = window.doc(firebaseInstances.primaryDb, '/public/data/users', editingUser.id);
                    await window.updateDoc(userDoc, {
                        pin: editingUser.pin,
                        role: editingUser.role,
                        fullName: editingUser.fullName.toUpperCase(),
                        phoneNumber: editingUser.phoneNumber
                    });
                    setEditingUser(null);
                    showModal("User updated successfully!");
                } catch (error) {
                    console.error("Error updating user:", error);
                    showModal("Failed to update user.");
                }
            };

            const handleDeleteUser = (userId) => {
                if (!firebaseInstances) return;
                showModal("Are you sure you want to delete this user?", async () => {
                    try {
                        const userDoc = window.doc(firebaseInstances.primaryDb, '/public/data/users', userId);
                        await window.deleteDoc(userDoc);
                        showModal("User deleted successfully.");
                    } catch (error) {
                        console.error("Error deleting user:", error);
                        showModal("Failed to delete user.");
                    }
                });
            };

            return (
                <div className="p-4 sm:p-6 lg:p-8">
                    <h2 className="text-3xl font-bold mb-6">User Management</h2>
                    
                    <div className="bg-white p-6 rounded-lg shadow-md mb-8">
                        <h3 className="text-xl font-semibold mb-4">Add New User</h3>
                        <form onSubmit={handleAddUser} className="space-y-4">
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">Username</label>
                                    <input type="text" placeholder="Username" value={newUser.username} onChange={e => setNewUser({...newUser, username: e.target.value.toUpperCase()})} className="mt-1 p-2 border rounded w-full uppercase" required/>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">Full Name</label>
                                    <input type="text" placeholder="Full Name" value={newUser.fullName} onChange={e => setNewUser({...newUser, fullName: e.target.value.toUpperCase()})} className="mt-1 p-2 border rounded w-full uppercase" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">Phone Number</label>
                                    <input type="text" placeholder="Phone Number" value={newUser.phoneNumber} onChange={e => setNewUser({...newUser, phoneNumber: e.target.value})} className="mt-1 p-2 border rounded w-full" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">4-Digit PIN</label>
                                    <input type="text" placeholder="4-Digit PIN" value={newUser.pin} maxLength="4" onChange={e => setNewUser({...newUser, pin: e.target.value.replace(/\D/,'')})} className="mt-1 p-2 border rounded w-full" required/>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">Role</label>
                                    <select value={newUser.role} onChange={e => setNewUser({...newUser, role: e.target.value})} className="mt-1 p-2 border rounded w-full bg-white">
                                        <option value="orderer">Orderer</option>
                                        <option value="warehouse">Warehouse</option>
                                        <option value="admin">Admin</option>
                                    </select>
                                </div>
                            </div>
                            <button type="submit" className="w-full bg-green-500 text-white p-2 rounded hover:bg-green-600">Add User</button>
                        </form>
                    </div>

                    <div className="bg-white p-6 rounded-lg shadow-md">
                        <h3 className="text-xl font-semibold mb-4">Existing Users</h3>
                        <div className="space-y-4">
                            {users.map(user => (
                                <div key={user.id} className="p-4 border rounded-lg flex flex-col md:flex-row justify-between md:items-center">
                                    {editingUser && editingUser.id === user.id ? (
                                        <div className="w-full">
                                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                                <input type="text" value={editingUser.fullName} onChange={e => setEditingUser({...editingUser, fullName: e.target.value.toUpperCase()})} className="p-2 border rounded uppercase" placeholder="Full Name"/>
                                                <input type="text" value={editingUser.phoneNumber} onChange={e => setEditingUser({...editingUser, phoneNumber: e.target.value})} className="p-2 border rounded" placeholder="Phone Number"/>
                                                <input type="text" value={editingUser.pin} maxLength="4" onChange={e => setEditingUser({...editingUser, pin: e.target.value.replace(/\D/,'')})} className="p-2 border rounded" placeholder="PIN"/>
                                                <select value={editingUser.role} onChange={e => setEditingUser({...editingUser, role: e.target.value})} className="p-2 border rounded bg-white">
                                                    <option value="orderer">Orderer</option>
                                                    <option value="warehouse">Warehouse</option>
                                                    <option value="admin">Admin</option>
                                                </select>
                                            </div>
                                            <div className="flex space-x-2 mt-4">
                                                <button onClick={handleUpdateUser} className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Save</button>
                                                <button onClick={() => setEditingUser(null)} className="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Cancel</button>
                                            </div>
                                        </div>
                                    ) : (
                                        <>
                                            <div className="flex-grow mb-4 md:mb-0">
                                                <p className="font-semibold text-lg">{user.fullName || 'No Name'} <span className="text-gray-500 font-normal">({user.username})</span></p>
                                                <p className="text-sm text-gray-600">Phone: {user.phoneNumber || 'N/A'}</p>
                                                <p className="text-sm text-gray-600">Role: <span className="font-medium">{user.role}</span></p>
                                            </div>
                                            <div className="flex space-x-2">
                                                <button onClick={() => setEditingUser({...user})} className="bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600">Edit</button>
                                                <button onClick={() => handleDeleteUser(user.id)} className="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">Delete</button>
                                            </div>
                                        </>
                                    )}
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };
        
        const RequestToolModal = ({ tool, sites, onConfirm, onCancel }) => {
            const [selectedSite, setSelectedSite] = useState('');
            useEffect(() => { if (sites.length > 0) setSelectedSite(sites[0].id); }, [sites]);
            const handleConfirm = () => {
                if (!selectedSite) { alert("Please select a project site."); return; }
                const site = sites.find(s => s.id === selectedSite);
                onConfirm(tool, site);
            };
            return (
                <div className="modal-overlay">
                    <div className="modal-content">
                        <h3 className="text-2xl font-bold mb-4">Request Tool</h3>
                        <p className="mb-2"><span className="font-semibold">Tool:</span> {tool.name}</p>
                        <p className="mb-4"><span className="font-semibold">Asset Tag:</span> {tool.assetTag}</p>
                        <div className="mb-6">
                            <label htmlFor="site-select-modal" className="block text-gray-700 font-bold mb-2">Select Project Site</label>
                            <select id="site-select-modal" value={selectedSite} onChange={e => setSelectedSite(e.target.value)} className="w-full p-2 border rounded bg-white">
                                {sites.length === 0 ? <option disabled>Loading sites...</option> : sites.map(site => <option key={site.id} value={site.id}>{site.name}</option>)}
                            </select>
                        </div>
                        <div className="flex justify-end space-x-4">
                            <button onClick={onCancel} className="px-6 py-2 rounded-md bg-gray-200 text-gray-800 hover:bg-gray-300">Cancel</button>
                            <button onClick={handleConfirm} className="px-6 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700">Confirm Request</button>
                        </div>
                    </div>
                </div>
            );
        };

        const ToolsPage = () => {
            const { user, firebaseInstances, showModal } = useAppContext();
            const [tools, setTools] = useState([]);
            const [sites, setSites] = useState([]);
            const [loading, setLoading] = useState(true);
            const [toolToRequest, setToolToRequest] = useState(null);
            const [searchTerm, setSearchTerm] = useState("");

            useEffect(() => {
                if (!firebaseInstances) return;
                const toolsCol = window.collection(firebaseInstances.primaryDb, '/public/data/tools');
                const unsubscribe = onSnapshot(toolsCol, (snapshot) => {
                    setTools(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    setLoading(false);
                }, (error) => { console.error("Error fetching tools:", error); showModal("Failed to load tools."); setLoading(false); });
                const fetchSites = async () => {
                    try {
                        const sitesCol = window.collection(firebaseInstances.secondaryDb, '/artifacts/default-app-id/public/data/sites');
                        const sitesSnapshot = await window.getDocs(sitesCol);
                        setSites(sitesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    } catch (error) { console.error("Error fetching sites:", error); }
                };
                fetchSites();
                return () => unsubscribe();
            }, [firebaseInstances]);

            const handleRequestConfirm = async (tool, site) => {
                const toolRef = window.doc(firebaseInstances.primaryDb, '/public/data/tools', tool.id);
                try {
                    await window.runTransaction(firebaseInstances.primaryDb, async (transaction) => {
                        const toolDoc = await transaction.get(toolRef);
                        if (!toolDoc.exists()) throw new Error("Tool does not exist!");
                        if (toolDoc.data().status !== 'Available') throw new Error("Tool is no longer available.");
                        transaction.update(toolRef, { status: 'Pending Approval', requestedBy: user.username, requestedById: user.id, locationId: site.id, locationName: site.name, requestedDate: window.serverTimestamp() });
                    });
                    showModal(`Request for "${tool.name} (${tool.assetTag})" submitted successfully!`);
                } catch (error) { console.error("Error requesting tool:", error); showModal(`Could not request tool. Reason: ${error.message}`);
                } finally { setToolToRequest(null); }
            };
            
            const getStatusClass = (status) => {
                switch (status) {
                    case 'Available': return 'bg-green-100 text-green-800';
                    case 'Pending Approval': return 'bg-yellow-100 text-yellow-800';
                    case 'Approved': return 'bg-blue-100 text-blue-800';
                    case 'Borrowed': return 'bg-purple-100 text-purple-800';
                    case 'Denied': return 'bg-red-100 text-red-800';
                    default: return 'bg-gray-100 text-gray-800';
                }
            };

            const filteredTools = tools.filter(tool => tool.condition === 'Good' && tool.status === 'Available').filter(tool => tool.name.toLowerCase().includes(searchTerm.toLowerCase()) || (tool.assetTag && tool.assetTag.toLowerCase().includes(searchTerm.toLowerCase())));

            if (loading) return <LoadingSpinner message="Loading Tools..." />;

            return (
                <>
                    {toolToRequest && <RequestToolModal tool={toolToRequest} sites={sites} onConfirm={handleRequestConfirm} onCancel={() => setToolToRequest(null)} />}
                    <div className="p-4 sm:p-6 lg:p-8">
                        <h2 className="text-3xl font-bold mb-6">Tools Library</h2>
                        <input type="text" placeholder="Search by tool name or asset tag..." className="w-full p-3 mb-6 border rounded-lg shadow-sm uppercase" value={searchTerm} onChange={e => setSearchTerm(e.target.value.toUpperCase())} />
                        <div className="bg-white p-6 rounded-lg shadow-md">
                            <div className="md:hidden space-y-4">
                                {filteredTools.map(tool => (
                                    <div key={tool.id} className="bg-gray-50 p-4 rounded-lg shadow">
                                        <div className="font-bold text-lg">{tool.name}</div>
                                        <div className="text-sm text-gray-600">Asset Tag: <span className="font-semibold">{tool.assetTag}</span></div>
                                        <div className="text-sm text-gray-600">Status: <span className={`ml-2 px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusClass(tool.status)}`}>{tool.status}</span></div>
                                        <div className="text-sm text-gray-600">Location: <span className="font-semibold">{tool.locationName || 'N/A'}</span></div>
                                        <button onClick={() => setToolToRequest(tool)} className="mt-4 w-full bg-blue-500 text-white px-3 py-2 rounded hover:bg-blue-600">Request Borrow</button>
                                    </div>
                                ))}
                            </div>
                            <div className="hidden md:block overflow-x-auto">
                                <table className="min-w-full">
                                    <thead className="bg-gray-200">
                                        <tr>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tool Name</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Asset Tag</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody className="bg-white divide-y divide-gray-200">
                                        {filteredTools.map(tool => (
                                            <tr key={tool.id}>
                                                <td className="px-6 py-4 whitespace-nowrap font-medium">{tool.name}</td>
                                                <td className="px-6 py-4 whitespace-nowrap font-semibold">{tool.assetTag}</td>
                                                <td className="px-6 py-4 whitespace-nowrap"><span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusClass(tool.status)}`}>{tool.status}</span></td>
                                                <td className="px-6 py-4 whitespace-nowrap">{tool.locationName || 'N/A'}</td>
                                                <td className="px-6 py-4 whitespace-nowrap"><button onClick={() => setToolToRequest(tool)} className="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">Request Borrow</button></td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </>
            );
        };

        const MyToolRequestsPage = () => {
            const { user, firebaseInstances, showModal } = useAppContext();
            const [myRequests, setMyRequests] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (!firebaseInstances || !user) return;
                const toolsCol = window.collection(firebaseInstances.primaryDb, '/public/data/tools');
                const q = window.query(toolsCol, where("requestedById", "==", user.id));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    setMyRequests(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => (b.requestedDate?.seconds || 0) - (a.requestedDate?.seconds || 0)));
                    setLoading(false);
                }, (error) => { console.error("Error fetching my tool requests:", error); showModal("Failed to load your tool requests."); setLoading(false); });
                return () => unsubscribe();
            }, [firebaseInstances, user]);
            
            const getStatusClass = (status) => {
                switch (status) {
                    case 'Available': return 'bg-green-100 text-green-800';
                    case 'Pending Approval': return 'bg-yellow-100 text-yellow-800';
                    case 'Approved': return 'bg-blue-100 text-blue-800';
                    case 'Borrowed': return 'bg-purple-100 text-purple-800';
                    case 'Denied': return 'bg-red-100 text-red-800';
                    default: return 'bg-gray-100 text-gray-800';
                }
            };

            if (loading) return <LoadingSpinner message="Loading Your Tool Requests..." />;

            return (
                <div className="p-4 sm:p-6 lg:p-8">
                    <h2 className="text-3xl font-bold mb-6">My Tool Requests</h2>
                    <div className="bg-white p-6 rounded-lg shadow-md">
                        {myRequests.length === 0 ? <p className="text-center text-gray-500">You have not requested any tools.</p> : (
                            <>
                                <div className="md:hidden space-y-4">
                                    {myRequests.map(req => (
                                        <div key={req.id} className="bg-gray-50 p-4 rounded-lg shadow">
                                            <div className="font-bold text-lg">{req.name} <span className="font-normal">({req.assetTag})</span></div>
                                            <div className="text-sm text-gray-600">Site: <span className="font-semibold">{req.locationName}</span></div>
                                            <div className="text-sm text-gray-600">Requested: <span className="font-semibold">{req.requestedDate?.toDate().toLocaleString()}</span></div>
                                            <div className="text-sm text-gray-600">Status: <span className={`ml-2 px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusClass(req.status)}`}>{req.status}</span></div>
                                        </div>
                                    ))}
                                </div>
                                <div className="hidden md:block overflow-x-auto">
                                    <table className="min-w-full">
                                        <thead className="bg-gray-200">
                                            <tr>
                                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tool Name</th>
                                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Asset Tag</th>
                                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Requested For Site</th>
                                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date Requested</th>
                                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Request Status</th>
                                            </tr>
                                        </thead>
                                        <tbody className="bg-white divide-y divide-gray-200">
                                            {myRequests.map(req => (
                                                <tr key={req.id}>
                                                    <td className="px-6 py-4 whitespace-nowrap font-medium">{req.name}</td>
                                                    <td className="px-6 py-4 whitespace-nowrap font-semibold">{req.assetTag}</td>
                                                    <td className="px-6 py-4 whitespace-nowrap">{req.locationName}</td>
                                                    <td className="px-6 py-4 whitespace-nowrap">{req.requestedDate?.toDate().toLocaleString()}</td>
                                                    <td className="px-6 py-4 whitespace-nowrap"><span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusClass(req.status)}`}>{req.status}</span></td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </>
                        )}
                    </div>
                </div>
            );
        };

        const ToolsManagementPage = () => {
            const { firebaseInstances, showModal } = useAppContext();
            const [tools, setTools] = useState([]);
            const [sites, setSites] = useState([]);
            const [loading, setLoading] = useState(true);
            const [newToolData, setNewToolData] = useState({ name: '', locationId: '' });
            const [editingTool, setEditingTool] = useState(null);
            const [searchTerm, setSearchTerm] = useState("");
            const [activeTab, setActiveTab] = useState('dashboard');
            const TOOL_CONDITIONS = ["Good", "Needs Repair", "Under Maintenance", "For Disposal"];

            useEffect(() => {
                if (!firebaseInstances) return;
                const toolsCol = window.collection(firebaseInstances.primaryDb, '/public/data/tools');
                const unsubscribeTools = window.onSnapshot(toolsCol, (snapshot) => {
                    setTools(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    setLoading(false);
                }, (error) => { console.error("Error fetching tools:", error); showModal("Failed to load tools."); setLoading(false); });
                const fetchSites = async () => {
                    try {
                        const sitesCol = window.collection(firebaseInstances.secondaryDb, '/artifacts/default-app-id/public/data/sites');
                        const sitesSnapshot = await window.getDocs(sitesCol);
                        setSites(sitesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    } catch (error) { console.error("Error fetching sites:", error); }
                };
                fetchSites();
                return () => unsubscribeTools();
            }, [firebaseInstances]);

            const handleAddTool = async (e) => {
                e.preventDefault();
                if (!newToolData.name.trim() || !newToolData.locationId) { showModal("Please provide a tool name and select a location."); return; }
                const toolName = newToolData.name.trim();
                const prefix = toolName.substring(0, 3).toUpperCase();
                const toolsQuery = query(collection(firebaseInstances.primaryDb, '/public/data/tools'), where("name", "==", toolName));
                const querySnapshot = await getDocs(toolsQuery);
                const newNumber = (querySnapshot.size + 1).toString().padStart(3, '0');
                const assetTag = `${prefix}-${newNumber}`;
                const site = sites.find(s => s.id === newToolData.locationId);
                try {
                    const toolsCol = window.collection(firebaseInstances.primaryDb, '/public/data/tools');
                    await window.addDoc(toolsCol, { name: toolName, assetTag: assetTag, status: 'Available', condition: 'Good', locationId: newToolData.locationId, locationName: newToolData.locationId === 'warehouse' ? 'Main Warehouse' : site?.name || 'Unknown' });
                    setNewToolData({ name: '', locationId: '' });
                    showModal(`Tool added successfully with Asset Tag: ${assetTag}`);
                } catch (error) { console.error("Error adding tool:", error); showModal("Failed to add tool."); }
            };

            const handleDeleteTool = async (toolId) => {
                showModal("Are you sure you want to delete this tool?", async () => {
                    try {
                        await window.deleteDoc(window.doc(firebaseInstances.primaryDb, '/public/data/tools', toolId));
                        showModal("Tool deleted successfully.");
                    } catch (error) { console.error("Error deleting tool:", error); showModal("Failed to delete tool."); }
                });
            };
            
            const handleUpdateTool = async () => {
                 if (!editingTool.name.trim() || !editingTool.assetTag.trim()) { showModal("Tool Name and Asset Tag cannot be empty."); return; }
                try {
                    const toolRef = window.doc(firebaseInstances.primaryDb, '/public/data/tools', editingTool.id);
                    await window.updateDoc(toolRef, { name: editingTool.name, assetTag: editingTool.assetTag });
                    setEditingTool(null);
                    showModal("Tool updated successfully.");
                } catch (error) { console.error("Error updating tool:", error); showModal("Failed to update tool."); }
            };

            const handleCheckOutTool = async (toolId) => {
                try {
                    const toolRef = window.doc(firebaseInstances.primaryDb, '/public/data/tools', toolId);
                    await window.updateDoc(toolRef, { status: 'Borrowed', borrowedDate: window.serverTimestamp() });
                    showModal("Tool checked out successfully.");
                } catch (error) { console.error("Error checking out tool:", error); showModal("Failed to check out tool."); }
            };

            const handleReturnTool = async (toolId) => {
                 try {
                    const toolRef = window.doc(firebaseInstances.primaryDb, '/public/data/tools', toolId);
                    await window.updateDoc(toolRef, { status: 'Available', locationId: 'warehouse', locationName: 'Main Warehouse', borrowedBy: null, requestedBy: null, requestedById: null, requestedDate: null });
                    showModal("Tool marked as returned to warehouse.");
                } catch (error) { console.error("Error returning tool:", error); showModal("Failed to return tool."); }
            };
            
            const handleConditionChange = async (toolId, newCondition) => {
                try {
                    const toolRef = window.doc(firebaseInstances.primaryDb, '/public/data/tools', toolId);
                    await window.updateDoc(toolRef, { condition: newCondition });
                    showModal("Tool condition updated successfully.");
                } catch (error) { console.error("Error updating tool condition:", error); showModal("Failed to update tool condition."); }
            };

            const filteredTools = tools.filter(tool => tool.name.toLowerCase().includes(searchTerm.toLowerCase()) || (tool.assetTag && tool.assetTag.toLowerCase().includes(searchTerm.toLowerCase())));
            
            const dashboardData = { total: tools.length, good: tools.filter(t => t.condition === 'Good').length, needsRepair: tools.filter(t => t.condition === 'Needs Repair').length, underMaintenance: tools.filter(t => t.condition === 'Under Maintenance').length, forDisposal: tools.filter(t => t.condition === 'For Disposal').length };
            const locationSummary = tools.reduce((acc, tool) => { acc[tool.locationName || 'Unknown'] = (acc[tool.locationName || 'Unknown'] || 0) + 1; return acc; }, {});

            if (loading) return <LoadingSpinner message="Loading Tools Management..." />;

            return (
                <div className="p-4 sm:p-6 lg:p-8">
                    <h2 className="text-3xl font-bold mb-6">Tools Management</h2>
                    <div className="mb-6 border-b border-gray-200">
                        <nav className="-mb-px flex space-x-8" aria-label="Tabs">
                            <button onClick={() => setActiveTab('dashboard')} className={`whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm ${activeTab === 'dashboard' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}`}>Dashboard</button>
                            <button onClick={() => setActiveTab('summary')} className={`whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm ${activeTab === 'summary' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}`}>Location Summary</button>
                            <button onClick={() => setActiveTab('manage')} className={`whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm ${activeTab === 'manage' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}`}>Manage All Tools</button>
                        </nav>
                    </div>
                    <div>
                        {activeTab === 'dashboard' && (
                            <div className="grid grid-cols-2 md:grid-cols-5 gap-4 text-center">
                                <div className="bg-blue-500 text-white p-6 rounded-lg shadow-lg"><p className="text-4xl font-bold">{dashboardData.total}</p><p className="text-lg">Total Tools</p></div>
                                <div className="bg-green-500 text-white p-6 rounded-lg shadow-lg"><p className="text-4xl font-bold">{dashboardData.good}</p><p className="text-lg">Good Condition</p></div>
                                <div className="bg-yellow-500 text-white p-6 rounded-lg shadow-lg"><p className="text-4xl font-bold">{dashboardData.needsRepair}</p><p className="text-lg">Needs Repair</p></div>
                                <div className="bg-orange-500 text-white p-6 rounded-lg shadow-lg"><p className="text-4xl font-bold">{dashboardData.underMaintenance}</p><p className="text-lg">Maintenance</p></div>
                                <div className="bg-red-500 text-white p-6 rounded-lg shadow-lg"><p className="text-4xl font-bold">{dashboardData.forDisposal}</p><p className="text-lg">For Disposal</p></div>
                            </div>
                        )}
                        {activeTab === 'summary' && (
                             <div className="bg-white p-6 rounded-lg shadow-md">
                                <h3 className="text-xl font-semibold mb-4">Tool Count by Location</h3>
                                <div className="overflow-x-auto">
                                    <table className="min-w-full"><thead className="bg-gray-200"><tr><th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th><th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Tools</th></tr></thead>
                                        <tbody className="bg-white divide-y divide-gray-200">{Object.entries(locationSummary).map(([location, count]) => (<tr key={location}><td className="px-6 py-4 whitespace-nowrap font-medium">{location}</td><td className="px-6 py-4 whitespace-nowrap font-bold">{count}</td></tr>))}</tbody>
                                    </table>
                                </div>
                            </div>
                        )}
                        {activeTab === 'manage' && (
                            <>
                                <div className="bg-white p-6 rounded-lg shadow-md mb-8">
                                    <h3 className="text-xl font-semibold mb-4">Add New Tool</h3>
                                    <form onSubmit={handleAddTool} className="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                                        <div><label className="block text-sm font-medium text-gray-700">Tool Name</label><input type="text" placeholder="e.g., Grinder" value={newToolData.name} onChange={e => setNewToolData({...newToolData, name: e.target.value.toUpperCase()})} className="mt-1 p-2 border rounded w-full uppercase" /></div>
                                        <div><label className="block text-sm font-medium text-gray-700">Location (Site)</label><select value={newToolData.locationId} onChange={e => setNewToolData({...newToolData, locationId: e.target.value})} className="mt-1 w-full p-2 border rounded bg-white"><option value="" disabled>Select a location</option><option value="warehouse">Main Warehouse</option>{sites.map(site => <option key={site.id} value={site.id}>{site.name}</option>)}</select></div>
                                        <button type="submit" className="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 h-10">Add Tool & Auto-Generate ID</button>
                                    </form>
                                </div>
                                <div className="bg-white p-6 rounded-lg shadow-md">
                                    <h3 className="text-xl font-semibold mb-4">Existing Tools</h3>
                                    <input type="text" placeholder="Search by tool name or asset tag..." className="w-full p-3 mb-4 border rounded-lg shadow-sm uppercase" value={searchTerm} onChange={e => setSearchTerm(e.target.value.toUpperCase())} />
                                    <div className="space-y-4">
                                        {filteredTools.map(tool => (
                                            <div key={tool.id} className="p-4 border rounded-lg flex flex-col md:flex-row justify-between items-center gap-4">
                                                {editingTool?.id === tool.id ? (
                                                    <><input type="text" value={editingTool.name} onChange={e => setEditingTool({...editingTool, name: e.target.value.toUpperCase()})} className="p-2 border rounded w-full md:w-auto uppercase" placeholder="Tool Name" /><input type="text" value={editingTool.assetTag} disabled className="p-2 border rounded w-full md:w-auto bg-gray-200" placeholder="Asset Tag" /><div className="flex space-x-2"><button onClick={handleUpdateTool} className="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">Save</button><button onClick={() => setEditingTool(null)} className="bg-gray-500 text-white px-3 py-1 rounded hover:bg-gray-600">Cancel</button></div></>
                                                ) : (
                                                    <><div className="flex-grow"><p className="font-semibold text-lg">{tool.name} <span className="text-base font-normal text-gray-500">({tool.assetTag})</span></p><p className="text-sm text-gray-600">Status: {tool.status} {tool.requestedBy && `(Req by ${tool.requestedBy} for ${tool.siteName})`}</p><p className="text-xs text-gray-500">Location: {tool.locationName}</p></div><div className="flex flex-wrap items-center gap-2"><div><label className="sr-only">Condition</label><select value={tool.condition || 'Good'} onChange={(e) => handleConditionChange(tool.id, e.target.value)} className="p-1 border rounded bg-white text-sm">{TOOL_CONDITIONS.map(c => <option key={c} value={c}>{c}</option>)}</select></div>{tool.status === 'Approved' && <button onClick={() => handleCheckOutTool(tool.id)} className="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600">Check Out</button>}{tool.status === 'Borrowed' && <button onClick={() => handleReturnTool(tool.id)} className="bg-indigo-500 text-white px-3 py-1 rounded hover:bg-indigo-600">Mark Returned</button>}<button onClick={() => setEditingTool(tool)} className="bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600">Edit</button><button onClick={() => handleDeleteTool(tool.id)} className="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">Delete</button></div></>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </>
                        )}
                    </div>
                </div>
            );
        };
        
        const ToolRequestsPage = () => {
            const { firebaseInstances, showModal } = useAppContext();
            const [requests, setRequests] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (!firebaseInstances) return;
                const toolsCol = window.collection(firebaseInstances.primaryDb, '/public/data/tools');
                const q = window.query(toolsCol, where("status", "==", "Pending Approval"));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    setRequests(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    setLoading(false);
                }, (error) => { console.error("Error fetching tool requests:", error); showModal("Failed to load tool requests."); setLoading(false); });
                return () => unsubscribe();
            }, [firebaseInstances]);

            const handleApprove = async (toolId) => {
                try {
                    await window.updateDoc(window.doc(firebaseInstances.primaryDb, '/public/data/tools', toolId), { status: 'Approved' });
                    showModal("Request approved. Tool is ready for checkout.");
                } catch (error) { console.error("Error approving request:", error); showModal("Failed to approve request."); }
            };

            const handleDeny = async (toolId) => {
                try {
                    await window.updateDoc(window.doc(firebaseInstances.primaryDb, '/public/data/tools', toolId), { status: 'Available', requestedBy: null, requestedById: null, requestedDate: null });
                    showModal("Request denied. Tool is now available again.");
                } catch (error) { console.error("Error denying request:", error); showModal("Failed to deny request."); }
            };
            
            if (loading) return <LoadingSpinner message="Loading Tool Requests..." />;

            return (
                <div className="p-4 sm:p-6 lg:p-8">
                    <h2 className="text-3xl font-bold mb-6">Pending Tool Requests</h2>
                       <div className="bg-white p-6 rounded-lg shadow-md">
                            <div className="md:hidden space-y-4">
                                {requests.map(req => (
                                    <div key={req.id} className="bg-gray-50 p-4 rounded-lg shadow">
                                        <div className="font-bold text-lg">{req.name} <span className="font-normal">({req.assetTag})</span></div>
                                        <div className="text-sm text-gray-600">By: <span className="font-semibold">{req.requestedBy}</span></div>
                                        <div className="text-sm text-gray-600">Site: <span className="font-semibold">{req.locationName}</span></div>
                                        <div className="text-sm text-gray-600">Date: <span className="font-semibold">{req.requestedDate?.toDate().toLocaleDateString()}</span></div>
                                        <div className="mt-4 flex space-x-2">
                                            <button onClick={() => handleApprove(req.id)} className="flex-1 bg-green-500 text-white px-3 py-2 rounded hover:bg-green-600">Approve</button>
                                            <button onClick={() => handleDeny(req.id)} className="flex-1 bg-red-500 text-white px-3 py-2 rounded hover:bg-red-600">Deny</button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                           <div className="hidden md:block overflow-x-auto">
                                <table className="min-w-full">
                                    <thead className="bg-gray-200">
                                        <tr>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tool Name</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Asset Tag</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Requested By</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Site</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody className="bg-white divide-y divide-gray-200">
                                        {requests.length === 0 && (<tr><td colSpan="6" className="text-center p-8 text-gray-500">No pending tool requests.</td></tr>)}
                                        {requests.map(req => (
                                            <tr key={req.id}>
                                                <td className="px-6 py-4 whitespace-nowrap font-medium">{req.name}</td>
                                                <td className="px-6 py-4 whitespace-nowrap font-semibold">{req.assetTag}</td>
                                                <td className="px-6 py-4 whitespace-nowrap">{req.requestedBy}</td>
                                                <td className="px-6 py-4 whitespace-nowrap">{req.locationName}</td>
                                                <td className="px-6 py-4 whitespace-nowrap">{req.requestedDate?.toDate().toLocaleDateString()}</td>
                                                <td className="px-6 py-4 whitespace-nowrap space-x-2">
                                                    <button onClick={() => handleApprove(req.id)} className="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600">Approve</button>
                                                    <button onClick={() => handleDeny(req.id)} className="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">Deny</button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                </div>
            );
        };
        
        const ForecastingPage = ({ setCurrentPage }) => {
            const { firebaseInstances, showModal } = useAppContext();
            const [inventory, setInventory] = useState([]);
            const [orders, setOrders] = useState([]);
            const [loading, setLoading] = useState(true);
            const [daysOfStock, setDaysOfStock] = useState(30);

            useEffect(() => {
                if (!firebaseInstances) return;
                const fetchData = async () => {
                    setLoading(true);
                    try {
                        const inventoryCol = window.collection(firebaseInstances.secondaryDb, 'artifacts/default-app-id/public/data/inventory');
                        const inventorySnapshot = await window.getDocs(inventoryCol);
                        const inventoryData = inventorySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setInventory(inventoryData);

                        const ordersCol = window.collection(firebaseInstances.primaryDb, "orders");
                        const ninetyDaysAgo = new Date();
                        ninetyDaysAgo.setDate(ninetyDaysAgo.getDate() - 90);
                        const q = query(ordersCol, where("createdAt", ">=", ninetyDaysAgo));
                        const ordersSnapshot = await window.getDocs(q);
                        const ordersData = ordersSnapshot.docs.map(doc => doc.data());
                        setOrders(ordersData);
                    } catch (error) {
                        console.error("Error fetching forecasting data:", error);
                        showModal("Failed to load data for forecasting.");
                    } finally {
                        setLoading(false);
                    }
                };
                fetchData();
            }, [firebaseInstances]);

            const analysis = useMemo(() => {
                if(inventory.length === 0) return [];

                return inventory.map(item => {
                    const totalOrdered = orders
                        .flatMap(order => order.items || [])
                        .filter(orderItem => orderItem.name === item.name)
                        .reduce((sum, orderItem) => sum + orderItem.quantity, 0);

                    const dailyUsage = totalOrdered / 90;
                    const targetStock = dailyUsage * daysOfStock;
                    const currentStock = item.qty || 0;
                    const suggestedReorder = Math.max(0, Math.ceil(targetStock - currentStock));

                    return {
                        ...item,
                        currentStock,
                        dailyUsage: dailyUsage.toFixed(2),
                        suggestedReorder,
                    };
                }).sort((a, b) => b.dailyUsage - a.dailyUsage);
            }, [inventory, orders, daysOfStock]);

            const handleAddToCart = (item, quantity) => {
                if (quantity <= 0) return;
                const savedCart = JSON.parse(localStorage.getItem('dlv_cart') || '{}');
                const existingItem = savedCart[item.id];
                const newCart = { ...savedCart, [item.id]: { ...item, quantity: (existingItem ? existingItem.quantity : 0) + quantity }};
                localStorage.setItem('dlv_cart', JSON.stringify(newCart));
                showModal({
                    message: `${quantity} x ${item.name} added to cart!`,
                    confirmText: 'Go to Cart',
                    onConfirm: () => setCurrentPage('cart'),
                    cancelText: 'Continue Shopping',
                    onCancel: () => {}
                });
            };

            if (loading) return <LoadingSpinner message="Analyzing Order Data..." />;

            return (
                <div className="p-4 sm:p-6 lg:p-8">
                    <h2 className="text-3xl font-bold mb-6">Forecasting & Reorder Suggestions</h2>
                    <div className="bg-white p-6 rounded-lg shadow-md mb-6">
                         <label htmlFor="daysOfStock" className="block text-sm font-medium text-gray-700">Days of Stock to Keep on Hand</label>
                         <input
                            type="number"
                            id="daysOfStock"
                            value={daysOfStock}
                            onChange={(e) => setDaysOfStock(parseInt(e.target.value, 10) || 0)}
                            className="mt-1 p-2 border rounded-md w-full sm:w-1/4"
                         />
                    </div>
                       <div className="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item Name</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Current Stock</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Avg. Daily Usage (90 days)</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Suggested Reorder Qty</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {analysis.map(item => (
                                        <tr key={item.id}>
                                            <td className="px-6 py-4 whitespace-nowrap">{item.name}</td>
                                            <td className="px-6 py-4 whitespace-nowrap">{item.currentStock}</td>
                                            <td className="px-6 py-4 whitespace-nowrap">{item.dailyUsage}</td>
                                            <td className="px-6 py-4 whitespace-nowrap font-bold text-blue-600">{item.suggestedReorder}</td>
                                            <td className="px-6 py-4 whitespace-nowrap">
                                                {item.suggestedReorder > 0 && (
                                                    <button onClick={() => handleAddToCart(item, item.suggestedReorder)} className="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600">Add to Cart</button>
                                                )}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                </div>
            );
        };

        const App = () => {
            const { user, loading, firebaseInstances, setNewOrderCount, setNewToolRequestCount } = useAppContext();
            const [currentPage, setCurrentPage] = useState('inventory');
            const [showWelcome, setShowWelcome] = useState(true);

            useEffect(() => {
                if (!user || !firebaseInstances || (user.role !== 'admin' && user.role !== 'warehouse')) return;
                const ordersQuery = window.query(window.collection(firebaseInstances.primaryDb, "orders"), where("isNew", "==", true));
                const toolsQuery = window.query(window.collection(firebaseInstances.primaryDb, "/public/data/tools"), where("status", "==", "Pending Approval"));
                const unsubOrders = window.onSnapshot(ordersQuery, (snapshot) => setNewOrderCount(snapshot.size));
                const unsubTools = window.onSnapshot(toolsQuery, (snapshot) => setNewToolRequestCount(snapshot.size));
                return () => { unsubOrders(); unsubTools(); };
            }, [user, firebaseInstances]);

            useEffect(() => {
                if (user) {
                    if (user.role === 'warehouse' || user.role === 'admin') setCurrentPage('order_management');
                    else setCurrentPage('inventory');
                }
            }, [user]);

            if (loading) return <LoadingSpinner message="Initializing Connections..." />;
            
            if (!firebaseInstances) {
                return (
                    <div className="flex items-center justify-center h-screen text-center text-red-500 p-4">
                        <h1 className="text-2xl font-bold">Fatal Error: Could not connect to databases.</h1>
                        <p>Please check your Firebase configuration and security rules, then refresh the page.</p>
                    </div>
                );
            }
            
            if (!user) {
                if (showWelcome) return <WelcomePage onVideoEnd={() => setShowWelcome(false)} />;
                return <LoginPage />;
            }

            const renderPage = () => {
                switch (currentPage) {
                    case 'inventory': return <InventoryPage setCurrentPage={setCurrentPage} />;
                    case 'cart': return <CartPage setCurrentPage={setCurrentPage} />;
                    case 'order_history': return <OrderHistoryPage />;
                    case 'order_management': return <OrderManagementPage />;
                    case 'user_management': return <UserManagementPage />;
                    case 'tools': return <ToolsPage />;
                    case 'tools_management': return <ToolsManagementPage />;
                    case 'tool_requests': return <ToolRequestsPage />;
                    case 'my_tool_requests': return <MyToolRequestsPage />;
                    case 'forecasting': return <ForecastingPage setCurrentPage={setCurrentPage} />;
                    default: return <InventoryPage setCurrentPage={setCurrentPage} />;
                }
            };

            return (
                <div className="h-screen bg-gray-100 flex flex-col">
                    <div className="flex-shrink-0 z-50 bg-white shadow-md">
                        <Header />
                        <Nav setCurrentPage={setCurrentPage} />
                    </div>
                    <main className="flex-grow overflow-y-auto">
                        {renderPage()}
                    </main>
                </div>
            );
        };

        const Root = () => (
            <AppProvider>
                <Toast />
                <Modal />
                <App />
            </AppProvider>
        );

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<Root />);
    </script>
</body>
</html>
